// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  password          String
  role              String   @default("USER") // ADMIN | USER
  nativeLanguageId  String
  learningLanguageId String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  nativeLanguage    Language @relation("UserNativeLanguage", fields: [nativeLanguageId], references: [id])
  learningLanguage  Language @relation("UserLearningLanguage", fields: [learningLanguageId], references: [id])
  
  phraseProgress    UserPhraseProgress[]
  
  @@map("users")
}

model Language {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
  
  phrasesNative    Phrase[] @relation("NativeLanguage")
  phrasesLearning  Phrase[] @relation("LearningLanguage")
  wordExplanationsNative WordExplanation[] @relation("WordExplanationNative")
  wordExplanationsLearning WordExplanation[] @relation("WordExplanationLearning")
  usersNative      User[]   @relation("UserNativeLanguage")
  usersLearning    User[]   @relation("UserLearningLanguage")
  
  @@map("languages")
}

model Phrase {
  id                String   @id @default(uuid())
  nativeLanguageId  String
  learningLanguageId String
  situationText     String   // Frase/situación en el idioma a aprender (ej: "Wie würden Sie einen Kaffee bestellen?")
  expectedAnswer    String   // Respuesta esperada en el idioma a aprender (ej: "Hallo, ich möchte bitte einen Kaffee.")
  situationExplanation String? // Explicación de la situación en el idioma nativo (opcional, para contexto)
  difficulty        String   // BEGINNER | INTERMEDIATE | ADVANCED
  cefrLevel         String   // A1 | A2 | B1 | B2 | C1 | C2
  category          String?  // Categoría temática (ej: "saludos", "comida", "viajes", etc.)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  nativeLanguage    Language @relation("NativeLanguage", fields: [nativeLanguageId], references: [id])
  learningLanguage  Language @relation("LearningLanguage", fields: [learningLanguageId], references: [id])
  
  userProgress      UserPhraseProgress[]
  wordExplanations  WordExplanation[]

  @@index([nativeLanguageId, learningLanguageId])
  @@index([nativeLanguageId, learningLanguageId, difficulty])
  @@index([nativeLanguageId, learningLanguageId, cefrLevel])
  @@map("phrases")
}

model UserPhraseProgress {
  id              String   @id @default(uuid())
  userId          String
  phraseId        String
  userAnswer      String
  aiFeedback      String?
  isCorrect       Boolean
  accuracyScore   Float?   // 0-100
  wordsLearned    String?  // JSON array of words
  wordsForgotten  String?  // JSON array of words that were learned but forgotten
  createdAt       DateTime @default(now())
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phrase          Phrase  @relation(fields: [phraseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, phraseId, createdAt])
  @@map("user_phrase_progress")
}

model WordExplanation {
  id                String   @id @default(uuid())
  phraseId          String
  word              String
  nativeLanguageId  String
  learningLanguageId String
  translation       String
  explanation       String
  examples          String?  // JSON array
  grammarNotes      String?
  grammarExplanation String? // Explicación gramatical completa de la frase
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  phrase            Phrase   @relation(fields: [phraseId], references: [id], onDelete: Cascade)
  nativeLanguage    Language @relation("WordExplanationNative", fields: [nativeLanguageId], references: [id])
  learningLanguage  Language @relation("WordExplanationLearning", fields: [learningLanguageId], references: [id])
  
  @@unique([phraseId, word, nativeLanguageId, learningLanguageId])
  @@index([phraseId, nativeLanguageId, learningLanguageId])
  @@index([phraseId])
  @@map("word_explanations")
}

